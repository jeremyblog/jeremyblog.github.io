---
layout: post
title: 大场景很low？是你牙齿不好吧，大叔
---
乐高大叔的积木理论似乎被大家放弃了，随之越俎代庖的"重复建轮子"：
<br>
“这个不行，满足不了我的业务，我要改掉它”
<br>
“这个(开源项目)代码我改了无数处了，作者太low了”
<br>
“文档太少了，我要重新写一个”
<br>
这样的言语我无法次地听到，又很快遗忘掉它们，因为我知道它的作者很快就要为之付出代价了。
<br>
因为如果你是员工，出于学习的目的或者增加自己的影响力，无可厚非。但是对于老板，希望最少
的代价获得最大的价值，坚决不能让你的架构师或者程序员这么干。理由很简单，他们这样并不是
为了生意。
<br>

**一次舌战**

这不是电影秋香中的星爷和对穿肠的心心相惜，而完全一场主义之战。

他们反对的理由：
1. zookeeper的技术栈没有贮备，似乎我不是团队的
2. zookeeper太小众了，书籍和论坛都比较少，确实helloworld文档不多
3. zookeeper大型场景中很low，证据呢？
4. 我们还有redis分布式锁，有MQ可以实现通知，有微服务、dubbo实现服务发现和管理，它们可
   以实现zookeeper的问题。

问题是我们使用zokkeeper更多的场景是为了可用性，你使用的代替品，他们的可用性实现比
zookeeper更强大，更简单？



**纸上谈兵**

话说一天，狮子和狗熊在果园里大便。
<br>
几天后狮子大便附近的树长的比熊大便附近的树茂盛。 
<br>
于是熊说了句包含哲理的话：“狮屎（事实）胜于熊便（雄辩）啊！！”
<br>

他们给出一个场景：
<br>
我们大多数的机器是虚拟机，6G内存4核，目前有200个项目，假设每个项目平均有30到40个watcher,元数据的多数非常小，另外每个项目平均需要10~100个节点扩展。
<br>
初略估计zookeeper需要支持200 * 100 最多为2w个连接，40*200大约8w的watcher。
<br>
**而经过某大型互联网团队的实践，单个zookeeper可以支持6000的请求和30w的watcher(对于元数
据很小的节点)**
<br>
我的策略是**隔离**
<br>
zookeeper有3种角色，领导者、追随者、观察者，观察者可以在不牺牲写操作的吞吐率的前提下服务更多的读操作。因为写操作仅需在领导者和追随者进行投票和同步即可。
<br>
实践出真理，同样是经权威的实践--zookeeper写集群的最佳性能是5台机器。
<br>
所以我的设计是这样的

![](http://oq6i0apwz.bkt.clouddn.com/observer.jpg)


隔离出核心集群和非核心集群，核心集群负责元数据的写入操作，而非核心集群则专门负责客户端的连接和读操作，这样可以避免过多的连接影响写操作，并提供了良好的跨机房集群。后续再专门一节来说。
<br>
再往大了想，如果将来的请求量是现在10倍呢？
<br>
也简单，再分出更多的核心集群和非核心集群咯，比如将业务非常多个set，每个set有自己核心和非核心集群。

![](http://oq6i0apwz.bkt.clouddn.com/observer2.jpg)

虽然不算大手笔，但是绝对够用，而且很接地气吧